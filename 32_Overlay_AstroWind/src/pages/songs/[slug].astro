---
import { getCollection } from 'astro:content';
import YouTube from '../../components/YouTube.astro';

const { slug } = Astro.params;
const songs = await getCollection('songs');
const song = songs.find(s => s.data.slug === slug);
if (!song) {
  throw new Error(`Song not found: ${slug}`);
}
const data = song.data;

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "MusicComposition",
  name: data.title,
  url: new URL(`/songs/${data.slug}`, Astro.site || 'https://example.com').toString(),
  composer: [{ "@type": "Person", name: "Bree Lowdermilk" }],
  lyricist: (data.credits||[]).find(c => c.toLowerCase().includes('lyrics by')) ? { "@type": "Person", name: "Kait Kerrigan" } : undefined,
  isPartOf: data.show ? { "@type": "CreativeWork", name: data.show } : undefined,
  audio: data.media?.spotifyUrl ? { "@type": "AudioObject", url: data.media.spotifyUrl } : undefined
};
---
<head>
  <title>{data.title}</title>
  <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
</head>
<main class="wrap">
  <article class="song">
    <header>
      <h1>{data.title}</h1>
      {data.show && <p class="show">From <strong>{data.show}</strong></p>}
    </header>

    {data.coverImage && <img class="cover" src={data.coverImage} alt={data.title} loading="lazy" />}

    {data.keys?.length ? (
      <section class="panel">
        <h2>Keys & Ranges</h2>
        <ul>
          {data.keys.map(k => <li><strong>{k.name}</strong>{k.range ? ` â€” ${k.range}` : ''}{k.isOriginal ? ' (Original)' : ''}</li>)}
        </ul>
      </section>
    ) : null}

    {(data.media?.youtubeId) ? (
      <section>
        <YouTube id={data.media.youtubeId} title={data.title} />
      </section>
    ) : null}

    {data.sheetMusic?.url && (
      <p><a class="btn" href={data.sheetMusic.url} target="_blank" rel="noopener">Get Sheet Music</a></p>
    )}

    {data.lyricExcerpt && (
      <blockquote>{data.lyricExcerpt}</blockquote>
    )}
  </article>
</main>

<style>
  .wrap{max-width:800px;margin:0 auto;padding:2rem}
  .show{color:#555}
  .panel{padding:1rem;border:1px solid #eee;border-radius:12px;margin:1rem 0}
  .cover{max-width:100%;border-radius:12px;margin:1rem 0}
  .btn{display:inline-block;padding:.5rem .75rem;border-radius:8px;border:1px solid currentColor;text-decoration:none}
</style>

