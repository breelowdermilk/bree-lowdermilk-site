---
import { getCollection } from 'astro:content';
import PageLayout from '~/layouts/PageLayout.astro';
import MediaTileOverlay from '~/components/media/MediaTileOverlay.astro';
import defaultImg from '~/assets/images/default.png';
import GLightboxInit from '~/components/media/GLightboxInit.astro';

const shows = await getCollection('shows');

// Only include requested shows for now
const showWhitelist = new Set([
  'ada-twist-scientist',
  'tales-from-the-bad-years',
  'ernxst',
  'justice',
  'republic',
  'the-mad-ones',
  'kill-the-boy-band',
  'dr-wonderful',
]);

const sortedShows = shows
  .filter((s) => showWhitelist.has(s.slug))
  .sort((a, b) => a.data.title.localeCompare(b.data.title));

// Render content for each show to include in inline modals
const showsWithContent = await Promise.all(
  sortedShows.map(async (show) => {
    const { Content } = await show.render();
    return { ...show, Content };
  })
);

const metadata = {
  title: 'Shows - Bree Lowdermilk',
  description: 'Explore musicals and theatrical works by Bree Lowdermilk, featuring original compositions, lyrics, and collaborative projects',
  openGraph: {
    type: 'website',
  },
};
---

<PageLayout {metadata}>
  <!-- Initialize GLightbox -->
  <GLightboxInit profile="shows" />
  
  <section class="px-6 sm:px-6 max-w-7xl mx-auto">
    <div class="py-12 md:py-16 lg:py-20 mx-auto">
      <header class="max-w-3xl mx-auto text-center mb-12">
        <h1 class="bree-h1-small mb-4">
          Shows
        </h1>
      </header>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4">
        {showsWithContent.map((show) => {
          const imageUrl = show.data.heroImage || defaultImg;
          const shortBlurb = show.data.synopsis
            ? show.data.synopsis.substring(0, 60) + (show.data.synopsis.length > 60 ? '...' : '')
            : 'Musical by Bree Lowdermilk';

          return (
            <MediaTileOverlay
              title={show.data.title}
              subtitle={show.data.status || show.data.year}
              category={show.data.venue || 'Theater'}
              className="aspect-[7/8] show-tile"
              credits={show.data.credits}
              shortBlurb={shortBlurb}
            >
              <a
                href={`#show-${show.slug}`}
                class="glightbox block w-full h-full relative"
                data-gallery="shows"
                data-title={show.data.title}
                data-type="inline"
                data-width="58vw"
                data-height="72vh"
              >
                <img
                  src={imageUrl}
                  alt={show.data.title || 'Show poster'}
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                  loading="lazy"
                />
              </a>
            </MediaTileOverlay>
          );
        })}
      </div>
      
      {sortedShows.length === 0 && (
        <div class="text-center py-12">
          <p class="text-gray-600 dark:text-gray-400">No shows available at this time.</p>
        </div>
      )}
    </div>
  </section>

  <!-- Hidden inline modal content for each show -->
  {showsWithContent.map((show) => {
    const imageUrl = show.data.heroImage || defaultImg;
    return (
      <div id={`show-${show.slug}`} class="show-modal-content" style="display: none;" aria-hidden="true">
        <div class="modal-inner">
          <!-- Hero Image -->
          <div class="modal-image-container">
            <img 
              src={imageUrl} 
              alt={show.data.title || 'Show image'}
              class="modal-hero-image"
            />
          </div>
          
          <!-- Content -->
          <div class="modal-content-body">
            <h2 class="modal-title">{show.data.title || 'Untitled Show'}</h2>
            
            {show.data.status && (
              <span class={`modal-status-badge ${
                show.data.status === 'licensed'
                  ? 'status-licensed'
                  : show.data.status === 'touring'
                  ? 'status-touring'
                  : show.data.status === 'development'
                  ? 'status-development'
                  : 'status-archived'
              }`}>
                {show.data.status.charAt(0).toUpperCase() + show.data.status.slice(1)}
              </span>
            )}
            
            {/* Synopsis */}
            {show.data.synopsis && (
              <div class="modal-section">
                <p class="modal-synopsis">{show.data.synopsis}</p>
              </div>
            )}
            
            {/* Main Content from Markdown */}
            {show.Content && (
              <div class="modal-section modal-markdown-content">
                <show.Content />
              </div>
            )}
            
            {/* Credits */}
            {show.data.credits && show.data.credits.length > 0 && (
              <div class="modal-section">
                <h3 class="modal-section-title">Credits</h3>
                <ul class="modal-credits-list">
                  {show.data.credits.map((credit) => (
                    <li>{credit}</li>
                  ))}
                </ul>
              </div>
            )}
            
            {/* Press Quotes */}
            {show.data.pressQuotes && show.data.pressQuotes.length > 0 && (
              <div class="modal-section">
                <h3 class="modal-section-title">Press</h3>
                <div class="modal-quotes">
                  {show.data.pressQuotes.map((quote) => (
                    <blockquote class="modal-quote">
                      <p>"{quote.quote}"</p>
                      <footer>
                        — <cite>{quote.outlet}</cite>
                        {quote.date && <span class="quote-date">({quote.date})</span>}
                      </footer>
                    </blockquote>
                  ))}
                </div>
              </div>
            )}
            
            {/* Licensing Link */}
            {show.data.links?.licensing && (
              <div class="modal-section">
                <a 
                  href={show.data.links.licensing}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="modal-licensing-link"
                >
                  View Licensing Information →
                </a>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  })}
</PageLayout>

<style>
  /* Ensure show tiles work as clickable elements */
  .show-tile {
    text-decoration: none;
    color: inherit;
    display: flex;
  }
  
  /* Modal content styling */
  .show-modal-content {
    max-width: 900px;
    margin: 0 auto;
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .modal-inner {
    background: white;
    border-radius: 12px;
    overflow: hidden;
  }
  
  .modal-image-container {
    width: 100%;
    max-height: 400px;
    overflow: hidden;
    background: #f3f4f6;
  }
  
  .modal-hero-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .modal-content-body {
    padding: 2rem;
  }
  
  .modal-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: #111827;
    line-height: 1.2;
  }
  
  .modal-status-badge {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: 9999px;
    margin-bottom: 1.5rem;
  }
  
  .status-licensed { background-color: #d1fae5; color: #065f46; }
  .status-touring { background-color: #dbeafe; color: #1e40af; }
  .status-development { background-color: #fef3c7; color: #92400e; }
  .status-archived { background-color: #f3f4f6; color: #374151; }
  
  .modal-section { margin-top: 2rem; }
  .modal-synopsis { font-size: 1.125rem; line-height: 1.75; color: #4b5563; }
  .modal-section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; color: #111827; }
  .modal-credits-list { list-style: disc; padding-left: 1.25rem; color: #4b5563; }
  
  .modal-quotes { display: grid; gap: 1rem; }
  .modal-quote { background: #f9fafb; border-left: 4px solid #6366f1; padding: 1rem; border-radius: 0.375rem; }
  .modal-quote p { color: #374151; font-size: 1.125rem; line-height: 1.625; }
  .modal-quote footer { font-size: 0.875rem; color: #6b7280; }
  .quote-date { margin-left: 0.5rem; }
  
  .modal-licensing-link {
    display: inline-flex; align-items: center; padding: 0.75rem 1.5rem;
    background-color: #6366f1; color: white; font-weight: 500; border-radius: 0.5rem;
    text-decoration: none; transition: background-color 0.2s;
  }
  .modal-licensing-link:hover { background-color: #4f46e5; }
  
  /* Markdown content styling */
  .modal-markdown-content { color: #4b5563; line-height: 1.75; }
  .modal-markdown-content :global(h1),
  .modal-markdown-content :global(h2),
  .modal-markdown-content :global(h3) { color: #111827; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; }
  .modal-markdown-content :global(p) { margin-bottom: 1rem; }
  .modal-markdown-content :global(ul),
  .modal-markdown-content :global(ol) { margin-left: 1.5rem; margin-bottom: 1rem; }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .modal-inner { background: #1f2937; }
    .modal-title, .modal-section-title { color: #f9fafb; }
    .modal-synopsis, .modal-credits-list, .modal-markdown-content { color: #d1d5db; }
    .modal-quote { background: #111827; border-left-color: #818cf8; }
    .modal-quote p { color: #e5e7eb; }
    .modal-quote footer { color: #9ca3af; }
    .modal-markdown-content :global(h1),
    .modal-markdown-content :global(h2),
    .modal-markdown-content :global(h3) { color: #f9fafb; }
    .modal-licensing-link { background-color: #818cf8; }
    .modal-licensing-link:hover { background-color: #6366f1; }
  }
  
  /* Mobile responsiveness */
  @media (max-width: 640px) {
    .modal-content-body { padding: 1.5rem; }
    .modal-title { font-size: 2rem; }
  }

  /* Show pages: tighter inline modal width for more overlay space */
  :global(.gslide-inline) { max-width: min(58vw, 900px); }
  @media (max-width: 768px) { :global(.gslide-inline) { max-width: 90vw; } }
</style>
